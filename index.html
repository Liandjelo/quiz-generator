<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modern AI Quiz Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';</script>
    
    <style>
        :root {
            --primary: #2563eb; /* A richer blue */
            --primary-hover: #1d4ed8;
            --bg-main: #f3f4f6;
            --bg-card: #ffffff;
            --text-dark: #1f2937;
            --text-light: #6b7280;
            --success-bg: #ecfdf5;
            --success-border: #10b981;
            --success-text: #065f46;
            --error-bg: #fef2f2;
            --error-border: #ef4444;
            --error-text: #991b1b;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-main);
            color: var(--text-dark);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: var(--bg-card);
            padding: 2.5rem;
            border-radius: 16px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }

        h2 {
            margin-top: 0;
            font-weight: 800;
            color: #111827;
            text-align: center;
            margin-bottom: 1.5rem;
        }

        /* --- Form Styling --- */
        .form-group {
            margin-bottom: 1.25rem;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #374151;
        }

        input[type="text"],
        input[type="number"],
        input[type="password"],
        input[type="file"] {
            width: 100%;
            padding: 0.75rem 1rem;
            box-sizing: border-box;
            border-radius: 8px;
            border: 2px solid #e5e7eb;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        input:focus {
            outline: none;
            border-color: var(--primary);
        }

        input[type="file"] {
            padding: 0.5rem;
            background: #f9fafb;
        }

        #genBtn {
            width: 100%;
            padding: 1rem;
            border-radius: 8px;
            border: none;
            background-color: var(--primary);
            color: white;
            font-size: 1.125rem;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.2);
        }

        #genBtn:hover {
            background-color: var(--primary-hover);
        }

        #genBtn:active {
            transform: scale(0.98);
        }

        #genBtn:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
            box-shadow: none;
        }

        #status {
            text-align: center;
            margin-top: 1.5rem;
            color: var(--text-light);
            font-weight: 500;
        }

        /* --- Quiz Card Styling --- */
        #quizOutput {
            max-width: 800px;
            margin: 2rem auto 0;
        }

        .quiz-item {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
        }

        .question {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: #111827;
            line-height: 1.4;
        }

        .options-grid {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        /* IMPROVED CHOICE VISIBILITY */
        .opt-btn {
            text-align: left;
            background: #ffffff;
            border: 2px solid #d1d5db;
            padding: 1rem 1.25rem;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            color: var(--text-dark);
            transition: all 0.2s ease;
            display: flex;
            align-items: flex-start;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }

        /* Adds the A. B. C. bold prefixes */
        .opt-btn strong {
            margin-right: 12px;
            font-weight: 800;
            color: var(--primary);
        }

        .opt-btn:hover:not(:disabled) {
            border-color: var(--primary);
            background: #eff6ff;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        /* --- Answer States --- */
        /* Disabled state (after clicking) */
        .opt-btn:disabled {
            cursor: default;
            opacity: 0.8;
            transform: none !important;
            box-shadow: none !important;
        }

        .correct {
            background-color: var(--success-bg) !important;
            border-color: var(--success-border) !important;
            color: var(--success-text) !important;
        }
        /* Add a checkmark icon before correct answers */
        .correct strong::before {
            content: "âœ“ ";
        }

        .wrong {
            background-color: var(--error-bg) !important;
            border-color: var(--error-border) !important;
            color: var(--error-text) !important;
        }
        /* Add an X icon before wrong answers */
        .wrong strong::before {
            content: "âœ— ";
        }

        /* --- Hidden Explanation --- */
        .answer-reveal {
            margin-top: 1.5rem;
            padding: 1.5rem;
            background: #fff7ed; /* Warmer orange background */
            border-radius: 8px;
            border-left: 6px solid #f97316;
            display: none; /* Hidden by default */
            color: #7c2d12;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>

<div class="container">
    <h2>âœ¨ AI Quiz Generator</h2>
    
    <div class="form-group">
        <label for="apiKey">1. OpenRouter API Key</label>
        <input type="password" id="apiKey" placeholder="sk-or-v1-..." autocomplete="off">
    </div>

    <div class="form-group">
        <label for="itemCount">2. Number of Questions (1-20)</label>
        <input type="number" id="itemCount" value="5" min="1" max="20">
    </div>

    <div class="form-group">
        <label for="pdfFile">3. Upload PDF Document</label>
        <input type="file" id="pdfFile" accept=".pdf">
    </div>

    <button id="genBtn" onclick="generateQuiz()">Generate Quiz Now</button>
    <p id="status"></p>
</div>

<div id="quizOutput"></div>

<script>
    async function generateQuiz() {
        // 1. Get Inputs
        const key = document.getElementById('apiKey').value.trim();
        const file = document.getElementById('pdfFile').files[0];
        const count = document.getElementById('itemCount').value; 
        const status = document.getElementById('status');
        const btn = document.getElementById('genBtn');
        const output = document.getElementById('quizOutput');

        // Basic Validation
        if (!key) return alert("Please enter your API Key.");
        if (!file) return alert("Please upload a PDF file.");
        if (count < 1) return alert("Please enter a number between 1 and 20.");

        // Reset UI State
        btn.disabled = true;
        output.innerHTML = '';
        status.innerHTML = 'â³ Step 1/3: Reading PDF file...';

        try {
            // Step 1: Extract Text
            const pdfText = await extractPdfText(file);
            
            // Step 2: Send to AI
            status.innerHTML = `ðŸ§  Step 2/3: AI is generating ${count} questions... (this may take 30s)`;
            const quizData = await fetchQuizData(pdfText, count, key);

            // Step 3: Render Result
            status.innerHTML = "âœ… Done! Scroll down to take the quiz.";
            renderQuiz(quizData);

        } catch (err) {
            status.innerHTML = `âŒ <span style="color:var(--error-text)">Error: ${err.message}</span>`;
            console.error(err);
        } finally {
            btn.disabled = false;
        }
    }

    // --- Helper: Extract PDF Text (Limited to first 6 pages for cost/speed) ---
    async function extractPdfText(file) {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        let text = "";
        const maxPages = Math.min(pdf.numPages, 6);
        for (let i = 1; i <= maxPages; i++) {
            const page = await pdf.getPage(i);
            const content = await page.getTextContent();
            text += content.items.map(item => item.str).join(" ") + "\n";
        }
        return text;
    }

    // --- Helper: Call OpenRouter API ---
    async function fetchQuizData(contextText, itemCount, apiKey) {
        // Using a highly capable model (Claude 3.5 Sonnet or GPT-4o recommended if budget allows)
        // Using Mistral 7B free for this demo requirement, change if you have credits.
        const modelId = "openai/gpt-4o-mini"; 
        // Alternatives if you have credits: "openai/gpt-4o-mini" or "anthropic/claude-3.5-sonnet"

        const prompt = `
        TASK: Create a multiple choice quiz based on the provided text.
        RULES:
        1. Output MUST be a valid raw JSON Array ONLY. Do not use markdown code blocks.
        2. Create exactly ${itemCount} questions.
        3. Ensure options are distinct.
        
        REQUIRED JSON FORMAT:
        [
            {
                "question": "Question text here?",
                "options": ["Option A text", "Option B text", "Option C text", "Option D text"],
                "answer_index": 0, // 0 for A, 1 for B, etc.
                "explanation": "Brief explanation why this is correct."
            }
        ]

        SOURCE TEXT:
        ${contextText.substring(0, 15000)} // Limit context to avoid token overflows
        `;

        const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
            method: "POST",
            headers: {
                "Authorization": `Bearer ${apiKey}`,
                "Content-Type": "application/json",
                "HTTP-Referer": window.location.href, // Good practice for OpenRouter rankings
            },
            body: JSON.stringify({
                model: modelId,
                messages: [{ role: "user", content: prompt }],
                temperature: 0.7, // Slightly creative but mostly factual
                max_tokens: 2500 // Ensure enough space for the response
            })
        });

        if (!response.ok) {
            const err = await response.json();
            throw new Error(err.error?.message || `API Error (${response.status})`);
        }

        const data = await response.json();
        let rawContent = data.choices[0].message.content.trim();

        // --- Robust JSON Cleaning ---
        // Sometimes AI still adds markdown despite instructions. This cleans it.
        if (rawContent.includes("```json")) {
            rawContent = rawContent.replace(/```json/g, "").replace(/```/g, "");
        }
        console.log(rawContent);
        // Ensure we only try to parse the array part
        const firstBracket = rawContent.indexOf('[');
        const lastBracket = rawContent.lastIndexOf(']');
        
        if (firstBracket !== -1 && lastBracket !== -1) {
            rawContent = rawContent.substring(firstBracket, lastBracket + 1);
            try {
                return JSON.parse(rawContent);
            } catch (e) {
                console.error("Failed JSON text:", rawContent);
                throw new Error("AI response was not valid JSON. Try again.");
            }
        } else {
             console.error("Raw output:", rawContent);
             throw new Error("AI did not generate a JSON array structure.");
        }
    }

    // --- Helper: Render Quiz to HTML ---
    function renderQuiz(questions) {
        const container = document.getElementById('quizOutput');
        const letters = ['A', 'B', 'C', 'D']; // For labeling options

        questions.forEach((q, index) => {
            const card = document.createElement('div');
            card.className = 'quiz-item';

            // 1. Render Question text
            card.innerHTML += `<div class="question">${index + 1}. ${q.question}</div>`;

            // 2. Container for options
            const optionsDiv = document.createElement('div');
            optionsDiv.className = 'options-grid';

            // 3. Container for explanation (hidden initially)
            const revealDiv = document.createElement('div');
            revealDiv.className = 'answer-reveal';
            // Safe access to the correct option text just in case indexing is slightly off
            const correctText = q.options[q.answer_index] || "See explanation";
            revealDiv.innerHTML = `<strong>âœ… Correct Answer:</strong> ${correctText} <br><br> <em>ðŸ’¡ ${q.explanation}</em>`;

            // 4. Generate clickable "Option Cards"
            q.options.forEach((optText, i) => {
                const btn = document.createElement('button');
                btn.className = 'opt-btn';
                // Add bold letter prefix automatically for better visibility
                btn.innerHTML = `<strong>${letters[i]}.</strong> ${optText}`;
                
                // Click Handler
                btn.onclick = () => {
                    // Disable further clicking on this question
                    const allBtns = optionsDiv.querySelectorAll('.opt-btn');
                    allBtns.forEach(b => b.disabled = true);
                    
                    // Show the explanation
                    revealDiv.style.display = 'block';

                    // Apply colors based on correctness
                    if (i === q.answer_index) {
                        btn.classList.add('correct'); // User clicked right
                    } else {
                        btn.classList.add('wrong');   // User clicked wrong
                        // Highlight the actual correct one so they know
                        allBtns[q.answer_index].classList.add('correct'); 
                    }
                };
                optionsDiv.appendChild(btn);
            });

            card.appendChild(optionsDiv);
            card.appendChild(revealDiv);
            container.appendChild(card);
        });
        
        // Smooth scroll to results
        container.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
</script>

</body>
</html>